// ============================
// Vibrant Impact Ministries JS
// Full Website Functionality
// Author: Emmanuel Iweh
// ============================

// ============================
// Global Variables
// ============================
let currentUser = null; // Will hold logged-in user info
let mediaItems = [];    // Array to store media items fetched from Firestore

// List of admin emails
const ADMIN_EMAILS = ['pastorvalentineifedayo@gmail.com']; 

// Firebase Firestore reference
const db = firebase.firestore();

// ============================
// Utility Functions
// ============================

// Toast notifications
function showToast(message, type = 'success') {
  const toast = document.createElement('div');
  toast.className = `toast ${type}`;
  toast.textContent = message;
  document.body.appendChild(toast);

  setTimeout(() => {
    toast.remove();
  }, 4000);
}

// Extract YouTube video ID from URL
function extractYouTubeId(url) {
  const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|&v=)([^#&?]*).*/;
  const match = url.match(regExp);
  return (match && match[2].length === 11) ? match[2] : '';
}

// Extract TikTok video ID from URL
function extractTikTokId(url) {
  const match = url.match(/video\/(\d+)/);
  return match ? match[1] : '';
}

// ============================
// Navigation & UI Functions
// ============================

// Show a specific section
function showSection(sectionId) {
  const sections = document.querySelectorAll('.section');
  sections.forEach(section => section.classList.remove('active'));

  const navButtons = document.querySelectorAll('.nav-btn');
  navButtons.forEach(btn => btn.classList.remove('active'));

  const selectedSection = document.getElementById(sectionId);
  if (selectedSection) selectedSection.classList.add('active');

  const activeButton = document.querySelector(`[onclick="showSection('${sectionId}')"]`);
  if (activeButton) activeButton.classList.add('active');

  const dropdown = document.getElementById('dropdownMenu');
  if (dropdown) dropdown.classList.remove('active');

  // If account section, load details
  if (sectionId === 'account') loadAccountDetails();

  window.scrollTo({ top: 0, behavior: 'smooth' });
}

// Toggle dropdown menu
function toggleMenu() {
  const dropdown = document.getElementById('dropdownMenu');
  dropdown.classList.toggle('active');
}

// Close dropdown when clicking outside
document.addEventListener('click', function(event) {
  const dropdown = document.getElementById('dropdownMenu');
  const menuToggle = document.querySelector('.menu-toggle');

  if (dropdown && menuToggle && !dropdown.contains(event.target) && !menuToggle.contains(event.target)) {
    dropdown.classList.remove('active');
  }
});

// ============================
// Modals
// ============================

// Close modal when clicking outside
['authModal', 'adminModal', 'editAccountModal'].forEach(modalId => {
  const modal = document.getElementById(modalId);
  if (modal) {
    modal.addEventListener('click', function(event) {
      if (event.target === this) {
        modal.classList.remove('active');
      }
    });
  }
});

// ============================
// User Account Functions
// ============================

// Load account details
async function loadAccountDetails() {
  if (!currentUser) {
    showToast('‚ùå Please login first to view your account.', 'error');
    openAuthModal();
    return;
  }

  document.getElementById('accountWelcome').textContent = `Welcome, ${currentUser.name}!`;
  document.getElementById('accountName').textContent = currentUser.name || 'Not provided';
  document.getElementById('accountEmail').textContent = currentUser.email || 'Not provided';
  document.getElementById('accountPhone').textContent = currentUser.phone || 'Not provided';
  
  document.getElementById('accountType').textContent = ADMIN_EMAILS.includes(currentUser.email) ? 'üëë Admin' : 'üë§ Member';

  try {
    const userDoc = await db.collection('users').doc(currentUser.uid).get();
    if (userDoc.exists && userDoc.data().registeredAt) {
      const registeredDate = userDoc.data().registeredAt.toDate().toLocaleDateString('en-US', {
        year: 'numeric', month: 'long', day: 'numeric'
      });
      document.getElementById('accountRegistered').textContent = registeredDate;
    } else {
      document.getElementById('accountRegistered').textContent = 'Date not available';
    }
  } catch (error) {
    console.error('Error loading registration date:', error);
    document.getElementById('accountRegistered').textContent = 'Date not available';
  }
}

// Open Edit Account modal
function openEditAccountModal() {
  if (!currentUser) {
    showToast('‚ùå Please login first to edit your account.', 'error');
    openAuthModal();
    return;
  }

  document.getElementById('editName').value = currentUser.name || '';
  document.getElementById('editPhone').value = currentUser.phone || '';
  document.getElementById('editEmail').value = currentUser.email || '';

  document.getElementById('editAccountModal').classList.add('active');
}

// Close Edit Account modal
function closeEditAccountModal() {
  document.getElementById('editAccountModal').classList.remove('active');
  document.getElementById('editAccountForm').reset();
}

// Handle Edit Account
async function handleEditAccount(event) {
  event.preventDefault();
  if (!currentUser) return showToast('‚ùå Please login first.', 'error');

  const name = document.getElementById('editName').value;
  const phone = document.getElementById('editPhone').value;
  const submitBtn = event.target.querySelector('button[type="submit"]');

  submitBtn.disabled = true;
  submitBtn.textContent = 'üîÑ Saving changes...';

  try {
    const userDocRef = db.collection('users').doc(currentUser.uid);
    const userDoc = await userDocRef.get();

    if (userDoc.exists) {
      await userDocRef.update({ name, phone, updatedAt: firebase.firestore.FieldValue.serverTimestamp() });
    } else {
      await userDocRef.set({
        name, email: currentUser.email, phone,
        registeredAt: firebase.firestore.FieldValue.serverTimestamp(),
        updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
        isAdmin: ADMIN_EMAILS.includes(currentUser.email)
      });
    }

    currentUser.name = name;
    currentUser.phone = phone;
    updateUserInterface();
    await loadAccountDetails();

    showToast('‚úÖ Your account details have been updated successfully!', 'success');
    closeEditAccountModal();
  } catch (error) {
    console.error('Edit account error:', error);
    showToast(`‚ùå Failed to update: ${error.message}`, 'error');
  } finally {
    submitBtn.disabled = false;
    submitBtn.textContent = 'üíæ Save Changes';
  }
}

// ============================
// Media Upload & Display
// ============================

// Map category to grid ID
function getCategoryGridId(category) {
  return {
    'recent-sermons': 'recentSermonsGrid',
    'fire-night': 'fireNightGrid',
    'youth-fellowship': 'youthFellowshipGrid',
    'church-photos': 'churchPhotosGrid',
    'events': 'eventsGrid'
  }[category] || 'recentSermonsGrid';
}

// Create media card
function createMediaCard(item) {
  const card = document.createElement('div');
  card.className = 'video-card';
  card.id = `media-${item.id}`;

  let mediaContent = '';
  let downloadBtn = '';

  if (item.type === 'video') {
    let embedUrl = '';
    if (item.url.includes('youtube.com') || item.url.includes('youtu.be')) {
      const videoId = extractYouTubeId(item.url);
      embedUrl = `https://www.youtube.com/embed/${videoId}`;
    } else if (item.url.includes('facebook.com')) {
      embedUrl = `https://www.facebook.com/plugins/video.php?href=${encodeURIComponent(item.url)}&show_text=false`;
    }

    mediaContent = `<div style="position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden; border-radius: 12px;">
                      <iframe src="${embedUrl}" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%;" frameborder="0" allowfullscreen></iframe>
                    </div>`;
  } else {
    downloadBtn = currentUser ? `<button class="download-btn" onclick="downloadImage('${item.url}', '${item.title}')">‚¨áÔ∏è Download</button>` : '';
    mediaContent = `<div style="position: relative;">${downloadBtn}<img src="${item.url}" alt="${item.title}" style="width: 100%; height: 250px; object-fit: cover;" onerror="this.src=''; this.alt='Image failed to load'; this.style.display='none';"></div>`;
  }

  const deleteBtn = currentUser && ADMIN_EMAILS.includes(currentUser.email) 
    ? `<button onclick="deleteMedia('${item.id}')" style="background: #dc2626; color: white; border: none; padding: 8px 16px; border-radius: 8px; cursor: pointer; margin-top: 10px; font-weight: 600;">üóëÔ∏è Delete</button>`
    : '';

  card.innerHTML = `${mediaContent}<div class="video-content"><h3>${item.title}</h3><p>${item.description || 'No description'}</p>${deleteBtn}</div>`;
  return card;
}

// Load media items
async function loadMediaItems() {
  try {
    const snapshot = await db.collection('media').orderBy('uploadedAt', 'desc').get();
    mediaItems = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

    const grids = ['recentSermonsGrid', 'fireNightGrid', 'youthFellowshipGrid', 'churchPhotosGrid', 'eventsGrid'];
    grids.forEach(gridId => {
      const grid = document.getElementById(gridId);
      if (grid) grid.innerHTML = '';
    });

    mediaItems.forEach(item => {
      const grid = document.getElementById(getCategoryGridId(item.category));
      if (grid) grid.appendChild(createMediaCard(item));
    });

    grids.forEach(gridId => {
      const grid = document.getElementById(gridId);
      if (grid && grid.children.length === 0) {
        grid.innerHTML = `<div class="video-card"><div class="video-placeholder">üì§</div><div class="video-content"><h3>No Media Yet</h3><p>Admins can upload videos and images for this category.</p></div></div>`;
      }
    });
  } catch (error) {
    console.error('Error loading media:', error);
  }
}

// Download image
function downloadImage(url, filename) {
  fetch(url)
    .then(res => res.blob())
    .then(blob => {
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = filename.replace(/[^a-z0-9]/gi, '_') + '.jpg';
      link.click();
      showToast('‚úÖ Image download started!', 'success');
    })
    .catch(() => showToast('‚ùå Failed to download image.', 'error'));
}

// Delete media
function deleteMedia(id) {
  const confirmBox = document.createElement('div');
  confirmBox.style.cssText = 'position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 30px; border-radius: 15px; box-shadow: 0 10px 40px rgba(0,0,0,0.3); z-index: 4000; text-align: center;';
  confirmBox.innerHTML = `<h3 style="color: #1e3a8a; margin-bottom: 20px;">Confirm Delete</h3><p style="color: #4b5563; margin-bottom: 25px;">Are you sure you want to delete this media?</p>
    <div style="display: flex; gap: 15px; justify-content: center;">
      <button onclick="confirmDelete('${id}')" style="padding: 10px 25px; background: #dc2626;">Yes, Delete</button>
      <button onclick="cancelDelete()" style="padding: 10px 25px;">Cancel</button>
    </div>`;
  const overlay = document.createElement('div');
  overlay.id = 'deleteOverlay';
  overlay.style.cssText = 'position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.5); z-index:3999;';
  overlay.appendChild(confirmBox);
  document.body.appendChild(overlay);
}

async function confirmDelete(id) {
  try {
    await db.collection('media').doc(id).delete();
    document.getElementById(`media-${id}`)?.remove();
    mediaItems = mediaItems.filter(item => item.id !== id);
    showToast('‚úÖ Media deleted successfully!', 'success');
  } catch (error) {
    console.error(error);
    showToast('‚ùå Failed to delete media.', 'error');
  } finally {
    document.getElementById('deleteOverlay')?.remove();
  }
}

function cancelDelete() { document.getElementById('deleteOverlay')?.remove(); }

// ============================
// Prayer & Contact Forms
// ============================

async function handlePrayerForm(event) {
  event.preventDefault();
  const name = document.getElementById('prayerName').value;
  const email = document.getElementById('prayerEmail').value;
  const phone = document.getElementById('prayerPhone').value;
  const request = document.getElementById('prayerRequest').value;
  const category = document.getElementById('prayerCategory').value;
  const submitBtn = event.target.querySelector('button[type="submit"]');

  submitBtn.disabled = true;
  submitBtn.textContent = 'üîÑ Submitting...';

  try {
    await db.collection('prayerRequests').add({
      name, email, phone, request, category,
      submittedAt: firebase.firestore.FieldValue.serverTimestamp()
    });

    const subject = `Prayer Request from ${name}`;
    const body = `Name: ${name}%0D%0AEmail: ${email}%0D%0APhone: ${phone || 'Not provided'}%0D%0ACategory: ${category}%0D%0A%0D%0APrayer Request:%0D%0A${request}`;
    window.open(`mailto:pastorvalentineifedayo@gmail.com?subject=${subject}&body=${body}`, '_blank');

    showToast('üôè Your prayer request has been submitted successfully!', 'success');
    document.getElementById('prayerForm').reset();
  } catch (error) {
    console.error(error);
    showToast('‚ùå Failed to submit prayer request.', 'error');
  } finally {
    submitBtn.disabled = false;
    submitBtn.textContent = 'üôè Submit Prayer Request';
  }
}

function handleContactForm(event) {
  event.preventDefault();
  const name = document.getElementById('contactName').value;
  const email = document.getElementById('contactEmail').value;
  const subject = document.getElementById('contactSubject').value;
  const message = document.getElementById('contactMessage').value;

  const mailtoLink = `mailto:pastorvalentineifedayo@gmail.com?subject=${subject} - From ${name}&body=Name: ${name}%0D%0AEmail: ${email}%0D%0A%0D%0AMessage:%0D%0A${message}`;
  window.open(mailtoLink, '_blank');

  showToast('üìß Your message has been prepared! Please send the email to complete.', 'success');
  document.getElementById('contactForm').reset();
}

// ============================
// Live Stream Functions
// ============================

// Show live stream
function showLiveStream(platform) {
  const container = document.getElementById('liveStreamContainer');
  const embedDiv = document.getElementById('liveStreamEmbed');
  const title = document.getElementById('liveStreamTitle');
  const note = document.getElementById('liveStreamNote');

  const youtubeUrl = localStorage.getItem('vimYoutubeLiveUrl') || '';
  const facebookUrl = localStorage.getItem('vimFacebookLiveUrl') || '';
  const tiktokUrl = localStorage.getItem('vimTiktokLiveUrl') || '';

  let embedCode = '', platformName = '', noteText = '';

  if (platform === 'youtube') {
    platformName = 'üì∫ YouTube Live';
    if (youtubeUrl) {
      const videoId = extractYouTubeId(youtubeUrl);
      embedCode = `<div style="position:relative;padding-bottom:56.25%;height:0;overflow:hidden;"><iframe src="https://www.youtube.com/embed/${videoId}?autoplay=1" style="position:absolute;top:0;left:0;width:100%;height:100%;" frameborder="0" allowfullscreen></iframe></div>`;
      noteText = 'üî¥ Live stream from YouTube.';
    } else embedCode = `<div style="background:#f3f4f6;padding:40px;border-radius:12px;text-align:center;"><p style="color:#6b7280;">YouTube Live stream link not configured yet.</p></div>`;
  } else if (platform === 'facebook') {
    platformName = 'üìò Facebook Live';
    if (facebookUrl) {
      embedCode = `<div style="position:relative;padding-bottom:56.25%;height:0;overflow:hidden;"><iframe src="https://www.facebook.com/plugins/video.php?href=${encodeURIComponent(facebookUrl)}&show_text=false&autoplay=1" style="position:absolute;top:0;left:0;width:100%;height:100%;" frameborder="0" allowfullscreen allow="autoplay; clipboard-write; encrypted-media; picture-in-picture; web-share"></iframe></div>`;
      noteText = 'üî¥ Live stream from Facebook.';
    } else embedCode = `<div style="background:#f3f4f6;padding:40px;border-radius:12px;text-align:center;"><p>Facebook Live stream link not configured yet.</p></div>`;
  } else if (platform === 'tiktok') {
    platformName = 'üéµ TikTok Live';
    if (tiktokUrl) {
      embedCode = `<div style="position:relative;padding-bottom:177.78%;height:0;overflow:hidden;max-width:605px;margin:0 auto;"><iframe src="https://www.tiktok.com/embed/${extractTikTokId(tiktokUrl)}" style="position:absolute;top:0;left:0;width:100%;height:100%;" frameborder="0" allowfullscreen></iframe></div>`;
      noteText = 'üî¥ TikTok Live stream.';
    } else embedCode = `<div style="background:#f3f4f6;padding:40px;border-radius:12px;text-align:center;"><p>TikTok Live stream link not configured yet.</p></div>`;
  }

  title.textContent = platformName;
  embedDiv.innerHTML = embedCode;
  note.textContent = noteText;
  container.style.display = 'block';
  container.scrollIntoView({ behavior: 'smooth', block: 'center' });
}

// Close live stream
function closeLiveStream() {
  const container = document.getElementById('liveStreamContainer');
  document.getElementById('liveStreamEmbed').innerHTML = '';
  container.style.display = 'none';
}

// ============================
// Admin Live Stream Settings
// ============================

async function handleLiveStreamUrlsUpdate(event) {
  event.preventDefault();
  if (!currentUser || !ADMIN_EMAILS.includes(currentUser.email)) {
    return showToast('‚ùå Only admins can update live stream URLs.', 'error');
  }

  const youtubeUrl = document.getElementById('youtubeLiveUrl').value;
  const facebookUrl = document.getElementById('facebookLiveUrl').value;
  const tiktokUrl = document.getElementById('tiktokLiveUrl').value;
  const submitBtn = event.target.querySelector('button[type="submit"]');

  submitBtn.disabled = true;
  submitBtn.textContent = 'üîÑ Saving...';

  try {
    localStorage.setItem('vimYoutubeLiveUrl', youtubeUrl);
    localStorage.setItem('vimFacebookLiveUrl', facebookUrl);
    localStorage.setItem('vimTiktokLiveUrl', tiktokUrl);

    await db.collection('settings').doc('liveStreamUrls').set({
      youtube: youtubeUrl,
      facebook: facebookUrl,
      tiktok: tiktokUrl,
      updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
      updatedBy: currentUser.email
    });

    showToast('‚úÖ Live stream URLs updated successfully!', 'success');
    document.getElementById('liveStreamUrlsForm').reset();
  } catch (error) {
    console.error(error);
    showToast('‚ùå Failed to update live stream URLs.', 'error');
  } finally {
    submitBtn.disabled = false;
    submitBtn.textContent = 'üíæ Save Live Stream URLs';
  }
}

// Load saved live stream URLs in admin form
function loadSavedLiveStreamUrls() {
  ['youtubeLiveUrl', 'facebookLiveUrl', 'tiktokLiveUrl'].forEach(id => {
    const input = document.getElementById(id);
    if (input) input.value = localStorage.getItem(`vim${id.charAt(0).toUpperCase() + id.slice(1)}`) || '';
  });
}

// Live status control
async function setLiveStatus(isLive) {
  if (!currentUser || !ADMIN_EMAILS.includes(currentUser.email)) return showToast('‚ùå Only admins can control live status.', 'error');
  try {
    localStorage.setItem('vimIsLive', isLive ? 'true' : 'false');
    await db.collection('settings').doc('liveStatus').set({
      isLive,
      updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
      updatedBy: currentUser.email
    });
    updateLiveStatusDisplay();
    showToast(`‚úÖ Stream is now ${isLive ? 'LIVE' : 'OFFLINE'}.`, 'success');
  } catch (error) {
    console.error(error);
    showToast('‚ùå Failed to update live status.', 'error');
  }
}

function updateLiveStatusDisplay() {
  const isLive = localStorage.getItem('vimIsLive') === 'true';
  const homeLiveAlert = document.getElementById('homeLiveAlert');
  if (homeLiveAlert) homeLiveAlert.style.display = isLive ? 'block' : 'none';
  const mediaLiveAlert = document.getElementById('mediaLiveAlert');
  if (mediaLiveAlert) mediaLiveAlert.style.display = isLive ? 'block' : 'none';
  const liveStatusText = document.getElementById('liveStatusText');
  if (liveStatusText) {
    liveStatusText.innerHTML = isLive ? 'üî¥ LIVE NOW' : '‚ö´ OFFLINE';
    liveStatusText.style.color = isLive ? '#dc2626' : '#6b7280';
  }
}

// ============================
// Initialization on Page Load
// ============================
window.addEventListener('DOMContentLoaded', function() {
  loadSavedLiveStreamUrls();
  updateLiveStatusDisplay();
  loadMediaItems();
  setInterval(updateLiveStatusDisplay, 10000);
});

